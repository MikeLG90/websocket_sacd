<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo Transmisión de Audio - ESP32</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <!-- Card principal -->
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h1 class="h3 mb-0">
              <i class="bi bi-broadcast"></i> Transmisión de Audio en Tiempo Real
            </h1>
          </div>
          <div class="card-body">
            <!-- Botones de control -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4">
              <button id="startBtn" class="btn btn-success btn-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-play-fill me-2" viewBox="0 0 16 16">
                  <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393"/>
                </svg>
                Iniciar transmisión
              </button>
              <button id="stopBtn" class="btn btn-danger btn-lg" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-stop-fill me-2" viewBox="0 0 16 16">
                  <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5"/>
                </svg>
                Detener
              </button>
            </div>

            <!-- Estado -->
            <div class="alert alert-info d-flex align-items-center" role="alert">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill me-2" viewBox="0 0 16 16">
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
              </svg>
              <div>
                <strong>Estado:</strong> <span id="status" class="badge bg-secondary">Inactivo</span>
              </div>
            </div>

            <!-- Reproductor de audio -->
            <div class="mt-4">
              <label class="form-label fw-bold">Reproductor de Audio:</label>
              <audio id="player" autoplay controls class="w-100"></audio>
            </div>
          </div>
          <div class="card-footer text-muted">
            <small>Conexión WebSocket: ws://10.0.0.3:8080</small>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const player = document.getElementById('player');

    let ws, audioCtx, processor, source;
    const audioQueue = [];

    // funcionn para actualizar el badge de estado
    function updateStatus(text, badgeClass) {
      statusEl.textContent = text;
      statusEl.className = `badge ${badgeClass}`;
    }

    startBtn.onclick = async () => {
      ws = new WebSocket('ws://192.168.1.153:80'); // ip de la maquina donde se ejecuta el websokcet
      ws.binaryType = 'arraybuffer';            

      ws.onopen = async () => {
        updateStatus('Conectado', 'bg-success');
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        // ---- CAPTURA Y ENVÍA ----
        audioCtx = new AudioContext();
        source = audioCtx.createMediaStreamSource(stream);
        processor = audioCtx.createScriptProcessor(4096, 1, 1);
        source.connect(processor);
        processor.connect(audioCtx.destination);

        processor.onaudioprocess = (e) => {
          const input = e.inputBuffer.getChannelData(0);
          const buffer = new Float32Array(input);
          if (ws.readyState === WebSocket.OPEN) ws.send(buffer);
        };

        startBtn.disabled = true;
        stopBtn.disabled = false;
        updateStatus('Transmitiendo audio...', 'bg-primary');
      };

      // ---- RECEPCIÓN ----
      const playCtx = new AudioContext();
      ws.onmessage = (event) => {
        const data = new Float32Array(event.data);
        const buf = playCtx.createBuffer(1, data.length, playCtx.sampleRate);
        buf.copyToChannel(data, 0);
        const src = playCtx.createBufferSource();
        src.buffer = buf;
        src.connect(playCtx.destination);
        src.start();
      };

      ws.onclose = () => updateStatus('Desconectado', 'bg-danger');
      ws.onerror = () => updateStatus('Error de conexión', 'bg-danger');
    };

    stopBtn.onclick = () => {
      if (processor) processor.disconnect();
      if (source) source.disconnect();
      if (audioCtx) audioCtx.close();
      if (ws) ws.close();
      startBtn.disabled = false;
      stopBtn.disabled = true;
      updateStatus('Detenido', 'bg-warning');
    };
  </script>
</body>
</html>